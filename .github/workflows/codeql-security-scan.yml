name: "ğŸ”’ CodeQL Security Scan"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight

# Add permissions at the workflow level
permissions:
  security-events: write
  actions: read
  contents: read

jobs:
  analyze:
    name: ğŸ” Analyze Code Security
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸš€ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Display Repository Info
      run: |
        echo "ğŸ’ IXIMI Legacy - Security Analysis"
        echo "==================================="
        echo "ğŸ“… $(date)"
        echo "ğŸ”— Repository: legacyiximi-afk/iximi-legacy"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo ""
        echo "ğŸ“ JavaScript files to analyze:"
        find . -name "*.js" -type f | grep -v node_modules
        echo ""
        echo "ğŸ“ˆ Lines of JavaScript:"
        find . -name "*.js" -type f -exec cat {} \; | wc -l
        echo "==================================="
    
    - name: âš™ï¸ Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-extended,security-and-quality
    
    - name: ğŸ”¨ Autobuild JavaScript
      uses: github/codeql-action/autobuild@v3
    
    - name: ğŸ”’ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"
    
    - name: âœ… Generate Security Report
      run: |
        echo "=========================================="
        echo "âœ… SECURITY ANALYSIS - SUCCESS"
        echo "=========================================="
        echo ""
        echo "ğŸ¯ PROJECT: IXIMI Legacy"
        echo "ğŸ“ DESCRIPTION: Blockchain certification for"
        echo "                indigenous Mexican textiles"
        echo "ğŸ‘¤ AUTHOR: EstefanÃ­a PÃ©rez VÃ¡zquez"
        echo "ğŸ“§ EMAIL: legacyiximi@gmail.com"
        echo ""
        echo "ğŸ“Š ANALYSIS RESULTS:"
        echo "- Status: âœ… COMPLETED"
        echo "- Language: JavaScript"
        echo "- Version: CodeQL v3"
        echo "- Time: $(date)"
        echo ""
        echo "ğŸ”’ SECURITY STATUS:"
        echo "- Scanning: Active"
        echo "- Frequency: On push + Weekly"
        echo "- Coverage: All JavaScript files"
        echo "- Alerts: Available in Security tab"
        echo ""
        echo "ğŸŒ LINKS:"
        echo "- Repository: https://github.com/legacyiximi-afk/iximi-legacy"
        echo "- Security: https://github.com/legacyiximi-afk/iximi-legacy/security"
        echo "- Actions: https://github.com/legacyiximi-afk/iximi-legacy/actions"
        echo "=========================================="
